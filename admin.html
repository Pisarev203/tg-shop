<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Админка</title>
  <style>
    :root{--bg:#0f1115;--card:#151923;--text:#e8ecf3;--muted:#9aa3b2;--line:rgba(255,255,255,.08);--accent:#2ea6ff;--danger:#ff4d4d;--r:16px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0 0 10px;font-size:18px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border-radius:var(--r);padding:12px}
    .row{display:grid;gap:8px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{width:100%;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--text);padding:10px;border-radius:12px;outline:none}
    textarea{min-height:70px;resize:none}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .primary{background:linear-gradient(135deg,var(--accent),#6d5cff);color:#fff}
    .ghost{background:rgba(255,255,255,.05);color:var(--text);border:1px solid var(--line)}
    .danger{background:rgba(255,77,77,.15);color:#ffb0b0;border:1px solid rgba(255,77,77,.35)}
    .list{margin-top:10px;border-top:1px solid var(--line);padding-top:10px;display:grid;gap:8px}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;display:grid;gap:8px}
    .muted{color:var(--muted);font-size:12px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
    .token{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .token input{max-width:240px}
    .ok{display:inline-flex;gap:6px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:#3ddc84;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Админка</h1>
        <div class="muted">Добавляй товары — они появятся в магазине (если твой публичный список берётся из /api/products).</div>
      </div>
      <div class="token">
        <input id="token" placeholder="ADMIN_TOKEN"/>
        <button class="ghost" id="saveToken">Сохранить</button>
        <span class="muted ok"><span class="dot"></span>Online</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h1>Добавить товар</h1>
        <div class="row">
          <div>
            <label>Название</label>
            <input id="pName" placeholder="Товар"/>
          </div>
          <div>
            <label>Цена</label>
            <input id="pPrice" type="number" value="0"/>
          </div>
          <div>
            <label>Категория (как в Swagger поле category)</label>
            <input id="pCategory" placeholder="Напр. Витрина"/>
          </div>
          <div>
            <label>Фото (URL) (как в Swagger поле photo_url)</label>
            <input id="pPhoto" placeholder="https://...jpg"/>
          </div>
          <div>
            <label>Описание</label>
            <textarea id="pDesc" placeholder="Описание товара…"></textarea>
          </div>

          <div class="btns">
            <button class="primary" id="addProd">Добавить</button>
            <button class="ghost" id="reloadPublic">Обновить список</button>
          </div>

          <div class="muted" id="status"></div>
        </div>
      </div>

      <div class="card">
        <h1>Товары (публичный список)</h1>
        <div class="muted">Берём из <code>/api/products</code>. Если у тебя другой путь — скажи, подстрою.</div>
        <div class="list" id="prodsList"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // === НАСТРОЙКИ ПУТЕЙ ===
  const ADD_PRODUCT_URL = "/admin/add-product";  // как в Swagger
  const PUBLIC_PRODUCTS_URL = "/api/products";    // публичный список

  const tokenEl = $("token");
  const saveTokenBtn = $("saveToken");
  const statusEl = $("status");

  const pName = $("pName");
  const pPrice = $("pPrice");
  const pCategory = $("pCategory");
  const pPhoto = $("pPhoto");
  const pDesc = $("pDesc");

  const addProd = $("addProd");
  const reloadPublic = $("reloadPublic");
  const prodsList = $("prodsList");

  tokenEl.value = localStorage.getItem("ADMIN_TOKEN") || "";

  saveTokenBtn.onclick = ()=>{
    localStorage.setItem("ADMIN_TOKEN", tokenEl.value.trim());
    alert("Сохранено");
  };

  function adminHeaders(){
    const t = (localStorage.getItem("ADMIN_TOKEN") || "").trim();
    return {"X-Admin-Token": t};
  }

  async function fetchText(url, opts={}){
    const r = await fetch(url, opts);
    const txt = await r.text();
    if(!r.ok) throw new Error(`${r.status}: ${txt}`);
    return txt;
  }

  async function fetchJson(url, opts={}){
    const r = await fetch(url, opts);
    const txt = await r.text();
    if(!r.ok) throw new Error(`${r.status}: ${txt}`);
    try { return JSON.parse(txt); } catch { return txt; }
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadPublic(){
    prodsList.innerHTML = "";
    try{
      const data = await fetchJson(PUBLIC_PRODUCTS_URL);
      const arr = Array.isArray(data) ? data : [];
      if(arr.length === 0){
        prodsList.innerHTML = `<div class="muted">Пока пусто. Добавь товар слева.</div>`;
        return;
      }
      for(const p of arr){
        prodsList.innerHTML += `
          <div class="item">
            <div><b>${escapeHtml(p.name)}</b> — <b>${escapeHtml(p.price)} ₽</b></div>
            <div class="muted">${escapeHtml(p.description||"")}</div>
            <div class="muted">${p.photo ? ("Фото: " + escapeHtml(p.photo)) : ""}</div>
            <div class="muted">${p.category ? ("Категория: " + escapeHtml(p.category)) : ""}</div>
          </div>
        `;
      }
    }catch(e){
      prodsList.innerHTML = `<div class="muted">Ошибка загрузки списка: ${escapeHtml(e.message)}</div>`;
    }
  }

  addProd.onclick = async ()=>{
    statusEl.textContent = "";
    try{
      const params = new URLSearchParams();
      // ВАЖНО: имена полей должны совпасть со Swagger (/admin/add-product)
      params.set("name", pName.value.trim());
      params.set("price", String(Number(pPrice.value || 0)));
      params.set("category", pCategory.value.trim());
      params.set("photo_url", pPhoto.value.trim());
      params.set("description", pDesc.value.trim());

      await fetchText(ADD_PRODUCT_URL, {
        method: "POST",
        headers: {
          ...adminHeaders(),
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body: params.toString()
      });

      pName.value = "";
      pPrice.value = "0";
      pCategory.value = "";
      pPhoto.value = "";
      pDesc.value = "";

      statusEl.textContent = "✅ Товар добавлен";
      await loadPublic();
    }catch(e){
      statusEl.textContent = "❌ Ошибка: " + e.message + " (проверь ADMIN_TOKEN и поля как в Swagger)";
      console.error(e);
      alert("Ошибка добавления товара:\n" + e.message);
    }
  };

  reloadPublic.onclick = loadPublic;

  // старт
  loadPublic();
</script>
</body>
</html>
