
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Магазин</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0f1115;
      --card:#151923;
      --text:#e8ecf3;
      --muted:#9aa3b2;
      --line: rgba(255,255,255,.08);
      --accent:#2ea6ff;
      --accent2:#20d08a;
      --danger:#ff4d4d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% -200px, rgba(46,166,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 10% 20%, rgba(32,208,138,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 110px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      position:sticky;top:0;z-index:20;
      padding:12px 0 10px;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.04);
    }
    .pill b{font-size:13px}
    .pill .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--accent2);
      box-shadow:0 0 0 4px rgba(32,208,138,.15);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media(min-width:720px){
      .grid{grid-template-columns: 1fr 1fr}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;gap:12px;
      padding:12px;
      min-height:118px;
    }
    .img{
      width:92px;height:92px;flex:0 0 92px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
      display:grid;place-items:center;
      color:rgba(255,255,255,.35);
      font-size:12px;
    }
    .img img{width:100%;height:100%;object-fit:cover;display:block}

    .info{flex:1;display:flex;flex-direction:column;gap:6px;min-width:0}
    .name{font-weight:700;font-size:15px;line-height:1.25;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .desc{color:var(--muted);font-size:12px;line-height:1.35;margin:0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:auto}
    .price{font-weight:800}
    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      padding:6px 8px;
    }
    .btn{
      border:0;
      background:transparent;
      color:var(--text);
      font-weight:800;
      width:30px;height:30px;border-radius:999px;
      display:grid;place-items:center;
      cursor:pointer;
      transition:.15s;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:scale(.96)}
    .count{min-width:18px;text-align:center;font-weight:800}

    /* Bottom cart */
    .bottom{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      background:rgba(10,12,16,.72);
      border-top:1px solid var(--line);
      backdrop-filter: blur(12px);
    }
    .bar{
      max-width:980px;margin:0 auto;

display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .bar .sum{
      display:flex;flex-direction:column;gap:2px;
      min-width:0;
    }
    .bar .sum .t{font-size:12px;color:var(--muted)}
    .bar .sum .v{font-size:16px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .primary{
      border:0;
      background:linear-gradient(135deg, var(--accent), #6d5cff);
      color:#fff;
      font-weight:900;
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      min-width:150px;
      box-shadow: 0 14px 30px rgba(46,166,255,.22);
      transition:.15s;
    }
    .primary:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
    .primary:active{transform:translateY(1px)}

    /* Modal */
    .overlay{
      position:fixed;inset:0;z-index:50;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
    }
    .overlay.show{display:flex}
    .modal{
      width:100%;
      max-width:980px;
      margin:0 auto;
      border-radius:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
    }
    .modalHead h2{margin:0;font-size:16px}
    .x{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      width:38px;height:38px;border-radius:12px;
      cursor:pointer;
      display:grid;place-items:center;
    }
    .modalBody{padding:12px 14px;display:grid;gap:10px}
    .field{display:grid;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:88px;resize:none}
    .mini{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .items{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.03);
      display:grid;gap:8px;
    }
    .it{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:13px;
    }
    .it .l{color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .it .r{font-weight:800;white-space:nowrap}
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;gap:10px;justify-content:space-between;align-items:center;
    }
    .ghost{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 14px;border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }

    .empty{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:var(--radius);
      padding:16px;
      color:var(--muted);
      text-align:center;
      margin-top:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Магазин</h1>
        <div class="sub" id="subtitle">Загружаю товары…</div>
      </div>

      <div class="pill" title="Статус">
        <span class="dot"></span>
        <b>Online</b>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">
      Товаров пока нет. Добавь товары через админку — и они появятся тут.
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottom">
    <div class="bar">
      <div class="sum">
        <div class="t">В корзине: <span id="cartCount">0</span></div>
        <div class="v">Итого: <span id="cartTotal">0</span> ₽</div>
      </div>
      <button id="checkoutBtn" class="primary" disabled>Оформить</button>
    </div>
  </div>

  <!-- Modal -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h2>Оформление заказа</h2>
        <button class="x" id="closeModal" aria-label="Закрыть">✕</button>
      </div>

      <div class="modalBody">
        <div class="items" id="orderItems"></div>

        <div class="mini">
          <div class="field">
            <label>Метро</label>
            <input id="metro" placeholder="Напр. Таганская" />
          </div>
          <div class="field">
            <label>Время</label>
            <input id="time" placeholder="Напр. 19:30" />
          </div>
        </div>

        <div class="field">
          <label>Комментарий</label>
          <textarea id="comment" placeholder="Подъезд, этаж, код домофона, пожелания…"></textarea>
        </div>
      </div>

      <div class="modalFoot">
        <button class="ghost" id="clearCart">Очистить</button>
        <button class="primary" id="sendOrder">Отправить заказ</button>
      </div>
    </div>
  </div>

  <script>
    // Telegram init
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const subtitle = document.getElementById('subtitle');

    const cartCount = document.getElementById('cartCount');
    const cartTotal = document.getElementById('cartTotal');
    const checkoutBtn = document.getElementById('checkoutBtn');

    const overlay = document.getElementById('overlay');
    const closeModal = document.getElementById('closeModal');
    const orderItemsEl = document.getElementById('orderItems');

    const metroEl = document.getElementById('metro');
    const timeEl = document.getElementById('time');
    const commentEl = document.getElementById('comment');

    const clearCartBtn = document.getElementById('clearCart');
    const sendOrderBtn = document.getElementById('sendOrder');

    // cart state: { [id]: qty }
    let products = [];
    let cart = loadCart();

    function loadCart() {
      try { return JSON.parse(localStorage.getItem('cart') || '{}'); }
      catch { return {}; }
    }
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    function rub(n){ return (n || 0).toString(); }

    function qtyOf(id){ return cart[id] || 0; }

    function setQty(id, qty){
      if (qty <= 0) delete cart[id];
      else cart[id] = qty;
      saveCart();
      render();
    }

    function calcTotals(){
      let count = 0;
      let total = 0;
      for (const [id, qty] of Object.entries(cart)){
        const p = products.find(x => String(x.id) === String(id));
        if (!p) continue;
        count += qty;
        total += (Number(p.price) || 0) * qty;
      }
      return {count, total};
    }

    function productCard(p){
      const id = String(p.id);
      const qty = qtyOf(id);

      const imgHtml = p.photo
        ? <img src="${p.photo}" alt="">
        : <span>без фото</span>;

      const desc = p.description || "";

      return `
        <div class="card">
          <div class="img">${imgHtml}</div>
          <div class="info">
            <p class="name" title="${escapeHtml(p.name  '')}">${escapeHtml(p.name  '')}</p>
            <p class="desc">${escapeHtml(desc)}</p>
            <div class="row">
              <div class="price">${rub(p.price)} ₽</div>
              <div class="qty">
                <button class="btn" data-act="minus" data-id="${id}">−</button>
                <div class="count" id="q_${id}">${qty}</div>
                <button class="btn" data-act="plus" data-id="${id}">+</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function render(){
      // grid
      if (!products.length){
        grid.innerHTML = "";
        empty.style.display = "block";
        subtitle.textContent = "Товаров нет";
      } else {
        empty.style.display = "none";
        grid.innerHTML = products.map(productCard).join("");
        subtitle.
textContent = "Выбирай товары и оформляй заказ";
      }

      // totals
      const t = calcTotals();
      cartCount.textContent = t.count;
      cartTotal.textContent = t.total;

      checkoutBtn.disabled = (t.count === 0);

      // bind card buttons
      grid.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.onclick = () => {
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          const cur = qtyOf(id);
          if (act === "plus") setQty(id, cur + 1);
          if (act === "minus") setQty(id, cur - 1);
        };
      });
    }

    function openModal(){
      // fill items list
      const lines = [];
      let total = 0;

      for (const [id, qty] of Object.entries(cart)){
        const p = products.find(x => String(x.id) === String(id));
        if (!p) continue;
        const sum = (Number(p.price) || 0) * qty;
        total += sum;

        lines.push(`
          <div class="it">
            <div class="l">${escapeHtml(p.name)} × ${qty}</div>
            <div class="r">${sum} ₽</div>
          </div>
        `);
      }

      if (!lines.length){
        orderItemsEl.innerHTML = <div class="it"><div class="l">Корзина пуста</div><div class="r">0 ₽</div></div>;
      } else {
        lines.push(`
          <div class="it" style="padding-top:8px;border-top:1px solid rgba(255,255,255,.08)">
            <div class="l" style="color:#e8ecf3;font-weight:900">Итого</div>
            <div class="r">${total} ₽</div>
          </div>
        `);
        orderItemsEl.innerHTML = lines.join("");
      }

      overlay.classList.add('show');
    }

    function close(){
      overlay.classList.remove('show');
    }

    checkoutBtn.onclick = openModal;
    closeModal.onclick = close;

    overlay.addEventListener('click', (e)=>{
      if (e.target === overlay) close();
    });

    clearCartBtn.onclick = ()=>{
      cart = {};
      saveCart();
      render();
      openModal(); // обновим модалку
    };

    sendOrderBtn.onclick = ()=>{
      const t = calcTotals();
      if (t.count === 0) return;

      const items = Object.entries(cart).map(([id, qty]) => {
        const p = products.find(x => String(x.id) === String(id));
        return {
          id: Number(id),
          name: p?.name || "",
          price: Number(p?.price) || 0,
          qty: qty
        };
      });

      const payload = {
        type: "order",
        items,
        total: t.total,
        metro: metroEl.value.trim(),
        time: timeEl.value.trim(),
        comment: commentEl.value.trim()
      };

      // отправляем в Telegram bot через WebAppData
      if (tg) {
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } else {
        // если открыто в обычном браузере
        alert("Заказ сформирован (не Telegram). Данные:\n" + JSON.stringify(payload, null, 2));
      }
    };

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function loadProducts(){
      try{
        const r = await fetch("/api/products", {cache:"no-store"});
        const data = await r.json();

        // поддержим разные форматы:
        // 1) [{id,name,price,description,photo,category}]
        // 2) {products:[...]}
        products = Array.isArray(data) ? data : (data.products || []);
        // нормализуем поля
        products = products.map(p => ({
          id: p.id,
          name: p.name ?? p.title ?? "Без названия",
          price: p.price ?? 0,
          description: p.description ?? p.desc ?? "",
          photo: p.photo ?? p.image ?? p.img ?? "",
          category: p.category ?? ""
        }));

        render();
      }catch(e){
        subtitle.textContent = "Ошибка загрузки товаров";
        grid.innerHTML = "";
        empty.style.display = "block";
        empty.textContent = "Не удалось загрузить товары. Проверь /api/products";
        console.error(e);
      }
    }

    // старт
loadProducts();
    render();
  </script>
  <script>
const checkoutBtn = document.getElementById("checkoutBtn");

checkoutBtn.addEventListener("click", async () => {
    const order = {
        tg_user: "test_user", // позже заменим на Telegram ID
        metro: document.getElementById("metro")?.value || "",
        time: document.getElementById("time")?.value || "",
        items: window.cart || [],
        total: window.cartTotal || 0
    };

    const res = await fetch("/api/order", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(order)
    });

    const data = await res.json();

    if (data.ok) {
        alert("Заказ оформлен! №" + data.order_id);
        window.cart = [];
        window.cartTotal = 0;
        location.reload();
    } else {
        alert("Ошибка при оформлении");
    }
});
</script>
</body>
</html>

