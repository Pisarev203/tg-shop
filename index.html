<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Магазин</title>
  <style>
    :root{--bg:#0f1115;--card:#151923;--text:#e8ecf3;--muted:#9aa3b2;--line:rgba(255,255,255,.08);--accent:#2ea6ff;--danger:#ff4d4d;--r:16px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:12px;white-space:pre-line}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:920px){.grid{grid-template-columns:2fr 1fr}}
    .card{border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border-radius:var(--r);padding:12px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .ghost{background:rgba(255,255,255,.05);color:var(--text);border:1px solid var(--line)}
    .primary{background:linear-gradient(135deg,var(--accent),#6d5cff);color:#fff}
    .danger{background:rgba(255,77,77,.15);color:#ffb0b0;border:1px solid rgba(255,77,77,.35)}
    input{width:100%;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--text);padding:10px;border-radius:12px;outline:none}
    .products{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:680px){.products{grid-template-columns:1fr 1fr}}
    .p{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:rgba(0,0,0,.25)}
    .ph{height:170px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
    .p img{width:100%;height:170px;object-fit:cover;display:block}
    .pb{padding:10px;display:grid;gap:8px}
    .pname{font-weight:900}
    .prow{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .price{font-weight:900}
    .cartItem{border:1px solid var(--line);border-radius:14px;padding:10px;display:grid;gap:6px}
    .qty{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .qty button{padding:6px 10px;border-radius:10px}
    .err{color:#ffb0b0;white-space:pre-line}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Магазин</h1>
      <div class="muted" id="subtitle">Выбери товары и оформи заказ</div>
    </div>
    <button class="ghost" id="reload">Обновить</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="muted">Товары</div>
      <div class="products" id="grid"></div>
      <div class="muted" id="empty" style="display:none;margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="muted">Корзина</div>

      <div style="display:grid;gap:8px;margin-top:8px">
        <div>
          <div class="muted">Твой Telegram юз (например: @mike)</div>
          <input id="tgUser" placeholder="@username"/>
        </div>
        <div>
          <div class="muted">Метро</div>
          <input id="metro" placeholder="Напр. Таганская"/>
        </div>
        <div>
          <div class="muted">Время</div>
          <input id="time" placeholder="Напр. 18:30"/>
        </div>
      </div>

      <div id="cart" style="display:grid;gap:8px;margin-top:10px"></div>

      <div class="prow" style="margin-top:10px">
        <div>
          <div class="muted">Итого</div>
          <div class="price" id="total">0 ₽</div>
        </div>
        <button class="danger" id="clear">Очистить</button>
        <button class="primary" id="order">Оформить</button>
      </div>

      <div class="muted err" id="orderErr" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
let products = [];
let cart = {}; // id -> qty

const grid = document.getElementById("grid");
const empty = document.getElementById("empty");
const reloadBtn = document.getElementById("reload");
const cartBox = document.getElementById("cart");
const totalEl = document.getElementById("total");

const tgUserEl = document.getElementById("tgUser");
const metroEl = document.getElementById("metro");
const timeEl = document.getElementById("time");

const clearBtn = document.getElementById("clear");
const orderBtn = document.getElementById("order");
const orderErr = document.getElementById("orderErr");

function money(n){ return (Number(n||0)) + " ₽"; }

window.addEventListener("error", (ev)=>{
  console.error("JS ERROR:", ev.error || ev.message);
});

async function loadProducts(){
  orderErr.textContent = "";
  try{
    const r = await fetch("/api/products", {cache:"no-store"});
    const txt = await r.text();
    if(!r.ok) throw new Error(txt);

    const data = JSON.parse(txt);
    console.log("API /api/products ->", data);

    products = Array.isArray(data) ? data : (data.products || []);
    render();
  }catch(e){
    console.error(e);
    grid.innerHTML = "";
    empty.style.display = "block";
    empty.textContent = "Не удалось загрузить товары. Открой F12 → Console.";
    orderErr.textContent = "Ошибка загрузки: " + e.message;
  }
}

function render(){
  empty.style.display = (products.length===0) ? "block" : "none";
  empty.textContent = "Пока нет товаров. Добавь их в /admin";
  grid.innerHTML = "";

  for(const p of products){
    const inCart = cart[p.id] || 0;
    const img = String(p.photo||"").trim();

    grid.innerHTML += `
      <div class="p">
        ${img ? `<img src="${escapeHtml(img)}" alt="">` : `<div class="ph">Нет фото</div>`}
        <div class="pb">
          <div class="prow">
            <div class="pname">${escapeHtml(p.name)}</div>
            <div class="price">${money(p.price)}</div>
          </div>
          <div class="muted">${escapeHtml(p.description||"")}</div>
          <div class="prow">
            <button class="${inCart ? "ghost":"primary"}" onclick="addToCart(${p.id})">
              ${inCart ? "Добавлено":"Добавить"}
            </button>
            ${inCart ? `<span class="muted">x${inCart}</span>` : ""}
          </div>
        </div>
      </div>
    `;
  }
  renderCart();
}

function renderCart(){
  cartBox.innerHTML = "";
  let total = 0;

  const items = Object.entries(cart).map(([id,qty])=>{
    const p = products.find(x=>String(x.id)===String(id));
    return p ? {p, qty:Number(qty)} : null;
  }).filter(Boolean);

  for(const it of items){
    total += Number(it.p.price||0) * it.qty;
    cartBox.innerHTML += `
      <div class="cartItem">
        <div class="prow">
          <div><b>${escapeHtml(it.p.name)}</b></div>
          <div class="price">${money(Number(it.p.price||0)*it.qty)}</div>
        </div>
        <div class="qty">
          <button class="ghost" onclick="dec(${it.p.id})">-</button>
          <b>${it.qty}</b>
          <button class="ghost" onclick="inc(${it.p.id})">+</button>
          <button class="danger" onclick="removeItem(${it.p.id})">Удалить</button>
        </div>
      </div>
    `;
  }

  totalEl.textContent = money(total);
}

function addToCart(id){
  cart[id] = (cart[id]||0) + 1;
  render();
}
function inc(id){ cart[id] = (cart[id]||0) + 1; renderCart(); render(); }
function dec(id){
  cart[id] = (cart[id]||0) - 1;
  if(cart[id] <= 0) delete cart[id];
  renderCart(); render();
}
function removeItem(id){ delete cart[id]; renderCart(); render(); }

clearBtn.onclick = ()=>{ cart = {}; renderCart(); render(); };

orderBtn.onclick = async ()=>{
  orderErr.textContent = "";

  const tgUser = (tgUserEl.value || "").trim();
  if(!tgUser){
    orderErr.textContent = "Введи свой Telegram юз (например: @mike)";
    return;
  }

  const items = Object.entries(cart).map(([id,qty])=>{
    const p = products.find(x=>String(x.id)===String(id));
    return p ? {id:p.id, name:p.name, price:p.price, qty:Number(qty)} : null;
  }).filter(Boolean);

  if(items.length===0){
    orderErr.textContent = "Корзина пустая";
    return;
  }

  const total = items.reduce((s,x)=>s + Number(x.price||0)*Number(x.qty||0), 0);

  try{
    const r = await fetch("/api/order", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        tg_user: tgUser,
        metro: metroEl.value,
        time: timeEl.value,
        items,
        total
      })
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(data.detail || (await r.text()));

    alert("Заказ отправлен! #" + data.order_id);
    cart = {};
    renderCart(); render();
  }catch(e){
    orderErr.textContent = "Ошибка оформления: " + e.message;
    console.error(e);
  }
};

reloadBtn.onclick = loadProducts;

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

loadProducts();
</script>
</body>
</html>
